# Replay 执行流程

## 前端触发

### 1. useReplay Hook

`simple-page-viewer/src/hooks/useReplay.ts`

用户点击 replay 按钮，调用：

```javascript
replayActions(actions, {
  delay: 1000,
  verbose: true,
  continueOnError: false,
});
```

### 2. API 调用

`simple-page-viewer/src/lib/api.ts:150`

```javascript
POST http://localhost:3100/api/replay
Body: {
  actions: [...],  // recording 的所有 actions
  options: {
    delay: 1000,
    verbose: true,
    continueOnError: false
  }
}
```

## 后端处理

### 3. 路由接收

`src/routes/ReplayRoutes.ts:29`

- 接收 actions 和 options
- 如果没有传 loops，从数据库查询该 recording 的 loops
- 调用 `replay(actions, options)`
- 传入 broadcast 回调函数

### 4. Replay 主函数

`src/replay.ts:replay()`

1. 创建 SimplePageClient
2. 遍历 actions 数组
3. 对每个 action：
   - 如果是 loop 内的 action → 调用 `executeLoop()`
   - 否则 → 调用 `executeSingleAction()`

### 5. 单个 Action 执行

`src/replay.ts:executeSingleAction()`

执行流程：

1. 根据 action.type 执行对应操作（create/navigate/act 等）
2. 如果 action 有 `extracts` 字段：
   - 调用 `client.getPageHtml(pageId)` 获取当前页面 HTML
   - 对每个 extractId：
     - fetch `http://localhost:3100/api/extractions/${extractId}` 获取 extraction template
     - 调用 `extractData(html, extraction.schema)` 执行提取
     - 存储结果：
       ```javascript
       {
         extractId,
         extractionName,
         result,
         schema,
         strategy,  // 包含 merge 和 unique 策略
         success: true
       }
       ```
   - broadcast `replay-extractions-complete` 事件

### 6. Loop 执行

`src/replay.ts:executeLoop()`

执行流程：

1. 循环执行 loop.loop_count 次
2. 每次迭代：
   - 执行 loop 内的所有 actions
   - 收集 extraction 结果到 `extractionCollector`
3. 循环结束后：
   - 遍历 extractionCollector
   - 对每个 extraction：
     - 获取 strategy (merge 和 unique)
     - 调用 `processLoopExtractionResults(iterations, extractId, strategy)`
     - 应用 merge 策略（concat/collect/merge）
     - 应用 unique 策略（去重）
   - 构造结果：
     ```javascript
     {
       type: 'loop',
       iterations: [...],      // 原始迭代数据
       processed: {            // 处理后的结果
         [extractId]: {
           result: [...],      // merge + unique 后的数据
           schema,
           strategy
         }
       }
     }
     ```
   - broadcast `replay-loop-extractions-complete` 事件

### 7. 数据提取

`src/utils/xray-extractor.ts:extractData()`

- 使用 cheerio 解析 HTML
- 支持两种 schema 格式：
  - 对象格式：`{field: "selector"}`
  - 数组格式：`["selector", {field: "selector"}]`
- 返回提取结果

### 8. Loop 策略处理

`src/utils/extraction-processor.ts:processLoopExtractionResults()`

- 从所有迭代中收集同一个 extraction 的结果
- 应用 merge 策略：
  - `concat`: 合并所有数组
  - `collect`: 每个迭代结果作为一个元素
  - `merge`: 合并对象
- 应用 unique 策略：
  - 按指定字段去重
  - keep='first' 保留第一个，keep='last' 保留最后一个

## WebSocket 广播

### 9. BroadcastService

`src/services/BroadcastService.ts`

通过 WebSocket 发送事件给前端：

- `replay-started` - replay 开始
- `replay-action-start` - 单个 action 开始
- `replay-action-complete` - 单个 action 完成
- `replay-extractions-complete` - 单次提取完成
- `replay-loop-extractions-complete` - loop 提取完成（包含 processed 结果）
- `replay-completed` - replay 全部完成

## 前端接收

### 10. WebSocket 事件监听

`simple-page-viewer/src/hooks/useReplay.ts`

监听事件并更新状态：

```javascript
on("replay-extractions-complete", (data) => {
  // 存储单次提取结果
  setReplayExtractionResults({
    [data.actionIndex]: {
      type: "single",
      results: data.results,
    },
  });
});

on("replay-loop-extractions-complete", (data) => {
  // 存储 loop 提取结果
  setReplayExtractionResults({
    [actionIndex]: {
      type: "loop",
      iterations: data.extractionResults[actionIndex].iterations,
      processed: data.extractionResults[actionIndex].processed,
    },
  });
});
```

### 11. 前端展示

`simple-page-viewer/src/components/ActionCard/index.tsx`

- 如果 action 有 extraction 且有结果，显示"查看"按钮
- 点击"查看"按钮：
  - 单次提取：显示 `extractionData.result`
  - Loop 提取：显示 `processed[extractId].result`（已应用 merge 和 unique）

## Recording 22 示例

**Actions:**

- Action 77: create
- Action 78: navigate 到小红书
- Action 79: act/scrollY 500px - 关联 extraction 18

**Extraction 18:**

```json
{
  "schema": ["section.note-item", {
    "title": ".footer .title span",
    "url": "a.cover@href",
    "cover_image": "a.cover img@src",
    "author": {...},
    "likes": "..."
  }],
  "strategy": {
    "merge": "concat",
    "unique": "url"
  }
}
```

**执行流程:**

1. 前端调用 `POST /api/replay`
2. 后端执行 actions[0-2]
3. 执行 action 79 时：
   - 执行 scrollY 操作
   - 调用 `client.getPageHtml()` 获取页面 HTML
   - 调用 `extractData(html, schema)` 提取笔记列表
   - broadcast 提取结果
4. 前端收到结果，显示"查看"按钮
